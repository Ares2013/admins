<?php $this->setLayout('amazeui');?>

<?php $this->block('title');?>游戏公告<?php $this->endBlock('title');?>

<?php $this->block('content');?>
<link rel="stylesheet" type="text/css" href="simditor/styles/simditor.css" />

<script type="text/javascript" src="simditor/scripts/module.js"></script>
<script type="text/javascript" src="simditor/scripts/hotkeys.js"></script>
<script type="text/javascript" src="simditor/scripts/uploader.js"></script>
<script type="text/javascript" src="simditor/scripts/simditor.js"></script>

<form id="mainForm" method="post" class="am-form">
    <!-- panel start -->
    <div class="am-panel am-panel-default">
      <div class="am-panel-hd am-cf" data-am-collapse="{target: '#collapse-panel-search'}">发布游戏公告<span class="am-icon-chevron-down am-fr" ></span></div>
      <div class="am-panel-bd am-collapse am-in" id="collapse-panel-search">

          <div class="am-g am-margin-vertical-sm">

              <div class="am-u-sm-12 am-u-md-12">

                  <textarea id="text-editor" name="content" placeholder="在这里输入游戏公告内容。。。" autofocus required></textarea>

              </div>

          </div>

          <div class="am-g am-margin-vertical-sm">

              <div class="am-u-sm-12 am-u-md-4">
                  <div class="am-form-group">
                      <label for="time_gap" class="am-text-sm">时间间隔(单位：分钟)：</label>
                      <input type="number" id="time_gap" name="time_gap" value="1" class="am-form-field am-input-sm" required/>
                  </div>
              </div>

              <div class="am-form-icon am-u-sm-12 am-u-md-4">
                  <div class="am-form-group">
                      <label for="date-start" class="am-text-sm">公告开始时间：</label>
                      <div class="am-form-icon">
                          <i id="date-start-icon" class="am-icon-calendar"></i>
                          <input id="date-start" type="text" name="time_start" value="" class="am-form-field am-input-sm" required pattern="\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}" />
                      </div>
                  </div>
              </div>

              <div class="am-form-icon am-u-sm-12 am-u-md-4">
                  <div class="am-form-group">
                      <label for="date-end" class="am-text-sm">公告结束时间：</label>
                      <div class="am-form-icon">
                          <i id="date-end-icon" class="am-icon-calendar"></i>
                          <input id="date-end" type="text" name="time_end" value="" class="am-form-field am-input-sm" required pattern="\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}"/>
                      </div>
                  </div>
              </div>

          </div>

          <div class="am-g am-margin-top-lg">
              <div class="am-u-sm-12 am-u-md-12">
                  <div class="am-form-group">
                      <label class="am-text-sm">选择分区：</label>
                      <label class="am-checkbox-inline"><input type="checkbox" id="select-all" onclick="sel();">全选</label>
                      <?php 

                        $ps = Game::getPlatformsServers2();
                        $platformsOpt = array();
                        foreach($ps as $pid => $servers){
                            foreach($servers as $sid => $name){
                                $tip = Game::platform($pid).$name . '区';
                                $key = "servers[{$pid}][]";
                                $val = $sid;
                                echo '<label class="am-checkbox-inline"><input class="server-checkbox" type="checkbox" name="'.$key.'" value="'.$val.'">'.$tip.'</label>';
                            }
                        }

                        ?>
                  </div>
              </div>
          </div>

          <div class="am-g">

              <div class="am-u-sm-12 am-u-md-12">
                  <div class="am-form-group">
                      <label class="am-text-sm">显示位置：</label>
                      <label class="am-checkbox-inline"><input name="type[]" type="checkbox" value="1">右上角公告</label>
                      <label class="am-checkbox-inline"><input name="type[]" type="checkbox" value="2">中间不滚动</label>
                      <label class="am-checkbox-inline"><input name="type[]" type="checkbox" value="3">聊天框</label>
                      <label class="am-checkbox-inline"><input name="type[]" type="checkbox" value="4">中间滚动</label>
                  </div>
              </div>

          </div>

          <div class="am-g am-margin-vertical-sm">

              <div class="am-u-sm-12 am-u-md-2 am-u-end">
                  <button class="am-btn am-btn-default am-input-sm" type="submit">发布</button>
              </div>

          </div>

      </div>
    </div>
    <!-- panel end -->

    <?php foreach($_GET as $k => $v):?>
    <?php if($k == 'kw') continue;?>
    <?php if($k == 'page') continue;?>
    <input type="hidden" name="<?php echo $k;?>" value="<?php echo $v;?>" />
    <?php endforeach;?>

  <table class="am-table am-table-striped am-table-compact am-text-xs am-table-hover" id="gm-table">
    <thead>
      <tr>
          <th class="table-check"><input type="checkbox" /></th>
          <th class="am-text-nowrap">ID</th>
          <th class="am-text-nowrap">服务器</th>
          <th class="am-text-nowrap">类型</th>
          <th class="am-text-nowrap">公告内容</th>
          <th class="am-text-nowrap">时间间隔</th>
          <th class="am-text-nowrap">开始时间</th>
          <th class="am-text-nowrap">结束时间</th>
          <th class="am-text-nowrap">操作</th>
      </tr>
  </thead>
  <tbody>

  <?php //dump($admin_pid); ?>
           <?php foreach($data['list'] as $v): ?>
           <?php 
           
           if(($v['name']=="$admin_name") or ($v['pid']==$admin_pid) or ($admin_pid=='')){
           ?>
           <tr>
               <td class="am-text-middle"><input type="checkbox" /></td>
               <td class="am-text-middle"><?php echo $v['id']?></td>
               <td class="am-text-middle"><?php echo $v['servers']?></td>
               <td class="am-text-middle"><?php echo $this->getTypeNames($v['types']);?></td>
               <td class="am-text-middle"><?php echo $v['message']?></td>
               <td class="am-text-middle"><?php echo $v['time_gap'];?>分钟</td>
               <td class="am-text-middle"><?php echo date('Y-m-d H:i:s', $v['time_start']);?></td>
               <td class="am-text-middle"><?php echo date('Y-m-d H:i:s', $v['time_end']);?></td>
               <td class="am-text-middle"><a href="?mod=setting&act=<?php echo $_GET['act'];?>&do=del&id=<?php echo $v['id']?>">删除</a></td>
           </tr>
           <?php } ?>
           <?php endforeach;?>
  </tbody>
</table>

<div class="am-cf">
    <div class="am-fr">
      <ul class="am-pagination">
        <?php echo $data['page_index']?>
      </ul>
    </div>
</div>


</form>

<script>
$(function() {
    // 右边框
    var $opOc = $('#op-offcanvas');
    $('.op-oc-js').on('click', function() {
        var opParams = $(this).data('op-params');
        if ( typeof(opParams) != "undefined" ) {
            var trObj = $(this).parent().parent();
            var name = trObj.children("td:eq(3)").text();
            var options = <?php echo Admin::getGmOptions();?>;
            var content = getGmLinks(options, opParams);
            $("#op-name").html(name);
            $("#op-offcanvas-content").html(content);
        }
        $opOc.offCanvas($(this).data('rel'));
        return false;
    });

    $opOc.on('open.offcanvas.amui', function() {
    }).on('close.offcanvas.amui', function() {
    });

    // 弹出框
    var $modal = $('#op-popup');
    $('td, #op-offcanvas').on('click', '.op-modal-open-js', function() {
        var name = $("#op-name").html();
        var url = $(this).data('url');
        var actionName = $(this).html();
        $('#op-popup-title').html(actionName + "： " + name);
        $modal.modal();
        $.get(url, function(result){
            $('#op-popup-content').html(result);
        });
    }).on('click', '.op-page-js', function() {
        var url = $(this).data('url');
        windowOpen(url, '_self');
    }).on('click', '.op-new-page-js', function() {
        var url = $(this).data('url');
        windowOpen(url, '_blank');
    });

    // 日期选择
    var startDate = new Date(2000, 1, 1);
    var endDate = new Date(2099, 11, 25);
    var $alert = $('#my-alert');
    $('#date-start-icon').datepicker().
        on('changeDate.datepicker.amui', function(event) {
            if (event.date.valueOf() > endDate.valueOf()) {
                $alert.find('p').text('开始日期应小于结束日期！').end().show();
            } else {
                $alert.hide();
                startDate = new Date(event.date);
                $('#date-start').val($('#date-start-icon').data('date') + ' 00:00:00');
            }
            $(this).datepicker('close');
        });
    $('#date-end-icon').datepicker().
        on('changeDate.datepicker.amui', function(event) {
            if (event.date.valueOf() < startDate.valueOf()) {
                $alert.find('p').text('结束日期应大于开始日期！').end().show();
            } else {
                $alert.hide();
                endDate = new Date(event.date);
                $('#date-end').val($('#date-end-icon').data('date') + ' 23:59:59');
            }
            $(this).datepicker('close');
        });

    var editor = new Simditor({
        textarea: $('#text-editor'),
        toolbar:[
        'color'           // 修改文字颜色
        ,'bold'           // 加粗文字
        ,'link'           // 插入链接
        ,'underline'      // 下划线文字
        // 'title'           // 标题文字
        // ,'italic'         // 斜体文字
        // ,'strikethrough'  // 删除线文字
        // ,'ol'             // 有序列表
        // ,'ul'             // 无序列表
        // ,'blockquote'     // 引用
        // ,'code'           // 代码
        // ,'table'          // 表格
        // ,'image'          // 插入图片
        // ,'hr'             // 分割线
        // ,'indent'         // 向右缩进
        // ,'outdent'        // 向左缩进
        // ,'alignment'      // 水平对齐
        ]
    });

});

function sel() {
    if($("#select-all").prop("checked")){
        $(".server-checkbox").prop("checked", true);
    }else{
        $(".server-checkbox").prop("checked", false);
    }
}
</script>
<?php $this->endBlock('content');?>
