<?php $this->setLayout('amazeui');?>

<?php $this->block('title');?>聊天查询<?php $this->endBlock('title');?>

<?php $this->block('buttons');?>
<?php echo Game::platformsServersForm($platformid, $serverid);?>
<?php $this->endBlock('buttons');?>

<?php $this->block('content');?>
<form id="mainForm" method="get" action="<?php echo request_uri(); ?>" class="am-form">
    <!-- panel start -->
    <div class="am-panel am-panel-default">
      <div class="am-panel-hd am-cf" data-am-collapse="{target: '#collapse-panel-search'}">搜索<span class="am-icon-chevron-down am-fr" ></span></div>
      <div class="am-panel-bd am-collapse am-in" id="collapse-panel-search">

          <div class="am-g am-margin-vertical-sm">

              <div class="am-u-sm-12 am-u-md-6">
                  <input type="text" name="kw[msg]" value="<?php echo $kw['kw_msg']?>" class="am-form-field am-input-sm" placeholder="聊天内容" />
              </div>

              <div class="am-u-sm-12 am-u-md-2">
                  <input type="text" name="kw[player_id]" value="<?php echo $kw['kw_player_id']?>" class="am-form-field am-input-sm" placeholder="角色ID" />
              </div>

              <div class="am-u-sm-12 am-u-md-4">
                  <input type="text" id="js_player_name" name="kw[player_name]" value="<?php echo $kw['kw_player_name']?>" class="am-form-field am-input-sm" placeholder="角色名称" />
              </div>


          </div>

          <div class="am-g am-margin-vertical-sm">

              <div class="am-form-icon am-u-sm-12 am-u-md-3">
                  <div class="am-form-icon">
                      <i id="date-start-icon" class="am-icon-calendar"></i>
                      <input id="date-start" type="text" name="kw[reg_st]" value="<?php echo $_REQUEST['kw']['reg_st'];?>" class="am-form-field am-input-sm" placeholder="聊天时间-开始" />
                  </div>
              </div>

              <div class="am-form-icon am-u-sm-12 am-u-md-3">
                  <div class="am-form-icon">
                      <i id="date-end-icon" class="am-icon-calendar"></i>
                      <input id="date-end" type="text" name="kw[reg_et]" value="<?php echo $_REQUEST['kw']['reg_et'];?>" class="am-form-field am-input-sm" placeholder="聊天时间-结束" />
                  </div>
              </div>

              <div class="am-u-sm-12 am-u-md-2 am-u-end">
                  <button class="am-btn am-btn-default am-input-sm" type="submit">搜索</button>
              </div>

          </div>

      </div>
    </div>
    <!-- panel end -->

    <?php foreach($_GET as $k => $v):?>
    <?php if($k == 'kw') continue;?>
    <?php if($k == 'page') continue;?>
    <input type="hidden" name="<?php echo $k;?>" value="<?php echo $v;?>" />
    <?php endforeach;?>

  <table class="am-table am-table-striped am-table-compact am-text-xs am-table-hover" id="gm-table">
    <thead>
      <tr>
          <th class="table-check"><input type="checkbox" /></th>
          <th class="am-text-nowrap am-hide-sm-only table-id">ID</th>
          <th class="am-text-nowrap table-title">名称</th>
          <th class="am-text-nowrap am-hide-sm-only">频道</th>
          <th class="am-text-nowrap table-date am-hide-md-down">时间</th>
          <th class="am-text-nowrap am-hide-sm-only">等级</th>
          <th class="">聊天内容</th>
          <th class="am-text-nowrap">封号</th>
          <th class="am-text-nowrap table-set">操作</th>
      </tr>
  </thead>
  <tbody>
           <?php
           foreach($data['list'] as $v):
           $status = Game::getStatus($v['player_id'], $v['server_id'], $platformid);
           ?>
           <tr <?php echo 'style="color:'.$status['color'].'"';?>>
               <td class="am-text-middle"><input type="checkbox" /></td>
               <td class="am-text-middle am-hide-sm-only"><?php echo $v['player_id']?></td>
               <td class="am-text-middle"><?php echo $v['player_name']?></td>
               <td class="am-text-middle am-hide-sm-only"><?php echo Game::chatType($v['type']);?></td>
               <td class="am-text-middle am-hide-md-down"><?php echo date('Y-m-d H:i:s', $v['time'])?></td>

               <td class="am-text-middle am-hide-sm-only"><?php echo $v['level'];?></td>
               <td class="am-text-middle"><?php echo htmlspecialchars($v['msg']);?></td>
               <td class="am-text-middle">
                    <?php if($v['server_id'] > 0):?>
                    <?php if($status['status'] == 1):?>
                    <button type="button" data-url="<?php echo $_SERVER["SCRIPT_NAME"];?>?mod=role&act=send_gmact&cmd=2&id=<?php echo $v['player_id']?>&serverid=<?php echo $v['server_id']?>&platformid=<?php echo $platformid;?>" class="am-btn am-btn-xs am-text-primary am-round am-margin-xs op-modal-open-js">
                        <span class="am-icon-pencil-square-o"></span> 解封
                    </button>
                    <?php elseif($status['status'] == 3):?>
                    <button type="button" data-url="<?php echo $_SERVER["SCRIPT_NAME"];?>?mod=role&act=send_gmact&cmd=4&id=<?php echo $v['player_id']?>&serverid=<?php echo $v['server_id']?>&platformid=<?php echo $platformid;?>" class="am-btn am-btn-xs am-text-primary am-round am-margin-xs op-modal-open-js">
                        <span class="am-icon-pencil-square-o"></span> 解IP
                    </button>
                    <?php else:?>
                    <button type="button" data-url="<?php echo $_SERVER["SCRIPT_NAME"];?>?mod=role&act=send_gmact&cmd=1&id=<?php echo $v['player_id']?>&serverid=<?php echo $v['server_id']?>&platformid=<?php echo $platformid;?>" class="am-btn am-btn-xs am-text-primary am-round am-margin-xs op-modal-open-js">
                        <span class="am-icon-pencil-square-o"></span> 封号
                    </button>
                    <?php endif;?>
                    <?php endif;?>
               </td>
               <td class="am-text-middle">
                   <button class="am-btn am-btn-default am-btn-xs am-text-secondary am-show-sm-only" onclick="more(this);return false;">
                       <span class="am-icon-th-list"></span> 详情
                   </button>
                   <button 
                       data-op-params='<?php echo $v['args'];?>' 
                       class="am-btn am-btn-default am-btn-xs am-text-secondary op-oc-js"
                       data-rel="open"
                       >
                       <span class="am-icon-pencil-square-o"></span> 操作
                   </button>
               </td>
           </tr>
           <?php endforeach;?>
  </tbody>
</table>

<div class="am-cf">
    <div class="am-fr">
      <ul class="am-pagination">
        <?php echo $data['page_index']?>
      </ul>
    </div>
</div>


</form>

<script>
$(function() {
    // 右边框
    var $opOc = $('#op-offcanvas');
    $('.op-oc-js').on('click', function() {
        var opParams = $(this).data('op-params');
        if ( typeof(opParams) != "undefined" ) {
            var trObj = $(this).parent().parent();
            var name = trObj.children("td:eq(2)").text();
            var options = <?php echo Admin::getGmOptions();?>;
            var content = getGmLinks(options, opParams);
            $("#op-name").html(name);
            $("#op-offcanvas-content").html(content);
        }
        $opOc.offCanvas($(this).data('rel'));
        return false;
    });

    $opOc.on('open.offcanvas.amui', function() {
    }).on('close.offcanvas.amui', function() {
    });

    // 弹出框
    var $modal = $('#op-popup');
    $('td, #op-offcanvas').on('click', '.op-modal-open-js', function() {
        var trObj = $(this).parent().parent();
        var name = trObj.children("td:eq(2)").text();
        var url = $(this).data('url');
        var actionName = $(this).html();
        $('#op-popup-title').html(actionName + "： " + name);
        $modal.modal();
        $.get(url, function(result){
            $('#op-popup-content').html(result);
        });
    }).on('click', '.op-page-js', function() {
        var url = $(this).data('url');
        windowOpen(url, '_self');
    }).on('click', '.op-new-page-js', function() {
        var url = $(this).data('url');
        windowOpen(url, '_blank');
    });

    // 日期选择
    var startDate = new Date(2000, 1, 1);
    var endDate = new Date(2099, 11, 25);
    var $alert = $('#my-alert');
    $('#date-start-icon').datepicker().
        on('changeDate.datepicker.amui', function(event) {
            if (event.date.valueOf() > endDate.valueOf()) {
                $alert.find('p').text('开始日期应小于结束日期！').end().show();
            } else {
                $alert.hide();
                startDate = new Date(event.date);
                $('#date-start').val($('#date-start-icon').data('date') + ' 00:00:00');
            }
            $(this).datepicker('close');
        });
    $('#date-end-icon').datepicker().
        on('changeDate.datepicker.amui', function(event) {
            if (event.date.valueOf() < startDate.valueOf()) {
                $alert.find('p').text('结束日期应大于开始日期！').end().show();
            } else {
                $alert.hide();
                endDate = new Date(event.date);
                $('#date-end').val($('#date-end-icon').data('date') + ' 23:59:59');
            }
            $(this).datepicker('close');
        });

});
</script>
<?php $this->endBlock('content');?>
