<?php $this->setLayout('amazeui');?>

<?php $this->block('title');?>运营数据统计<?php $this->endBlock('title');?>

<?php $this->block('content');?>

<form id="mainForm" method="post" class="am-form">

    <input type="hidden" name="submit_type" value="" id="submit_type">
    
    <!-- panel start -->
    <div class="am-panel am-panel-default">
      <div class="am-panel-hd am-cf" data-am-collapse="{target: '#collapse-panel-search'}">搜索<span class="am-icon-chevron-down am-fr" ></span></div>
      <div class="am-panel-bd am-collapse am-in" id="collapse-panel-search">

          <?php 
          $ps = Game::getPlatformsServers();
          $platformsOpt = array();
          foreach($ps as $pid => $servers):
          ?>
          <div class="am-g">
              <div class="am-u-sm-12 am-u-md-12">
                  <div class="am-form-group">
                      <label class="am-text-sm"><?php echo Game::platform($pid); ?>平台：</label>
                      <label class="am-checkbox-inline am-text-warning">
                          <input type="checkbox" id="platform-<?php echo $pid;?>" onclick="sel('<?php echo $pid;?>');">全选</label>
                      <?php 
                      foreach($servers as $sid => $name):
                      $name =  $name. '区';
                      $key = "servers[{$pid}][{$sid}]";
                      $checked = isset($selectedServers[$pid][$sid]) ? 'checked="true"' : '';
                      echo '<label class="am-checkbox-inline"><input '.$checked.' class="platform-'.$pid.'" type="checkbox" name="'.$key.'" value="1">'.$name.'</label>';
                      endforeach;
                      ?>
                  </div>
              </div>
          </div>
          <?php endforeach; ?>

          <div class="am-g">
              <div class="am-u-sm-12 am-u-md-12">
                  <div class="am-form-group">
                      <label class="am-text-sm">选择时间：</label>
                      <label class="am-checkbox-inline"><input <?php if(in_array('yesterday', $period))echo 'checked="true"';?> class="server-checkbox" type="checkbox" name="period[]" value="yesterday">昨天</label>
                      <label class="am-checkbox-inline"><input <?php if(in_array('week', $period))echo 'checked="true"';?> class="server-checkbox" type="checkbox" name="period[]" value="week">一周</label>
                      <label class="am-checkbox-inline"><input <?php if(in_array('all', $period))echo 'checked="true"';?> class="server-checkbox" type="checkbox" name="period[]" value="all">全部</label>
                  </div>
              </div>
          </div>

          <div class="am-g">

              <div class="am-form-icon am-u-sm-12 am-u-md-6">
                  <div class="am-form-group">
                      <label for="date-start" class="am-text-sm">自选时间-开始：</label>
                      <div class="am-form-icon">
                          <i id="date-start-icon" class="am-icon-calendar"></i>
                          <input id="date-start" type="text" name="time_start" value="<?php echo $timeStart;?>" class="am-form-field am-input-sm" pattern="\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}" />
                      </div>
                  </div>
              </div>

              <div class="am-form-icon am-u-sm-12 am-u-md-6">
                  <div class="am-form-group">
                      <label for="date-end" class="am-text-sm">自选时间-结束：</label>
                      <div class="am-form-icon">
                          <i id="date-end-icon" class="am-icon-calendar"></i>
                          <input id="date-end" type="text" name="time_end" value="<?php echo $timeEnd;?>" class="am-form-field am-input-sm" pattern="\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}"/>
                      </div>
                  </div>
              </div>

          </div>

          <div class="am-g">
              <div class="am-u-sm-12 am-u-md-12">
                  <div class="am-form-group">
                      <label class="am-checkbox-inline"><input <?php echo isset($this->input['perday']) ? 'checked="true" ' : '';?>class="" type="checkbox" name="perday" value="perday">显示每服每日详情</label>
                  </div>
              </div>
          </div>

          <div class="am-g">
              <div class="am-u-sm-12 am-u-md-12 am-u-end">
                  <button onclick="$('#submit_type').val('search')" class="am-btn am-btn-default am-input-sm" type="submit">搜索</button>
                  <!--
                  <button onclick="$('#submit_type').val('excel')" class="am-btn am-btn-default am-input-sm" type="submit">导出Excel</button>
                  -->
              </div>
          </div>

      </div>
    </div>

    <!-- panel end -->

    <?php foreach($_GET as $k => $v):?>
    <?php if($k == 'kw') continue;?>
    <?php if($k == 'page') continue;?>
    <input type="hidden" name="<?php echo $k;?>" value="<?php echo $v;?>" />
    <?php endforeach;?>

<script src="assets/js/jquery.tablesort.js"></script>
<style type="text/css">

th {
    cursor: pointer;
}

th:hover,
th.sorted.ascending:after {
    content: "  \2191";
}

th.sorted.descending:after {
    content: " \2193";
}

</style>
<table class="am-table-bordered am-table am-table-compact am-text-xs am-table-centered" id="mytable">
    <thead>
        <tr>
            <th class="am-text-nowrop">时间</th>
            <th class="am-text-nowrop">平台</th>
            <th class="number am-text-nowrop">分区</th>
            <th class="number am-text-nowrop" title="充值金额">金额</th>
            <th class="number am-text-nowrop" title="充值游戏币">游戏币</th>
            <th class="number am-text-nowrop">注册数</th>
            <th class="number am-text-nowrop" title="创建角色人数">创角数</th>
            <th class="number am-text-nowrop" title="创角数/安装量">创角率%</th>
            <th class="number am-text-nowrop">付费次数</th>
            <th class="number am-text-nowrop">付费人数</th>
            <th class="number am-text-nowrop" title="二次付费人数">二付人数</th>
            <th class="number am-text-nowrop" title="总付费人数/总创角人数">付费率%</th>
            <th class="number am-text-nowrop" title="总收入/总注册">收/注</th>
            <th class="number am-text-nowrop" title="收入/付费人数">ARPPU</th>
            <th class="number am-text-nowrop" title="在线10分钟以上的老用户">活跃</th>
            <th class="number am-text-nowrop" title="收入/活跃人数">ARPU</th>
        </tr>
    </thead>
    <tbody>
    <?php 
    foreach($data as $pid=>$servers):
    $pName = Game::platform($pid);
    foreach($servers as $sid=>$server):
    foreach($server as $time=>$stat):
    $class = '';
    $day = '';
    switch($time){
    case 'custom':
        $class = 'am-active';
        $day = '自选';
        break;
    case 'yesterday':
        $class = 'am-success';
        $day = '昨天';
        break;
    case 'week':
        $class = 'am-primary';
        $day = '一周';
        break;
    case 'all':
        $class = 'am-danger';
        $day = '全部';
        break;
    }
    ?>
    <?php if(isset($this->input['perday'])):?>
    <?php foreach($stat as $st):?>
    <tr class="<?php echo $class;?>">
        <td class="am-text-center"><?php echo date('Y-m-d', $st['day']).'('.$weekarray[date("w",$st['day'])].')';?></td>
        <td class="am-text-center"><?php echo $pName;?></td>
        <td class="am-text-center"><?php echo $st['sid'];?></td>
        <td class="am-text-center"><?php echo $st['money'       ];?></td>
        <td class="am-text-center"><?php echo $st['moneyGame'   ];?></td>
        <td class="am-text-center"><?php echo $st['regs'           ];?></td>
        <td class="am-text-center"><?php echo $st['creates'        ];?></td>
        <td class="am-text-center"><?php echo $st['rateCreatesRegs'];?></td>
        <td class="am-text-center"><?php echo $st['orders'         ];?></td>
        <td class="am-text-center"><?php echo $st['payPlayers'     ];?></td>
        <td class="am-text-center"><?php echo $st['payPlayers2'    ];?></td>
        <td class="am-text-center"><?php echo $st['ratePay'        ];?></td>
        <td class="am-text-center"><?php echo $st['rateMoneyRegs'  ];?></td>
        <td class="am-text-center"><?php echo $st['arppu'          ];?></td>
        <td class="am-text-center"><?php echo $st['activePlayers'  ];?></td>
        <td class="am-text-center"><?php echo $st['arpu'           ];?></td>
    </tr>
    <?php endforeach;?>
    <?php else:?>
    <tr class="<?php echo $class;?>">
        <td class="am-text-center"><?php echo $day;?></td>
        <td class="am-text-center"><?php echo $pName;?></td>
        <td class="am-text-center"><?php echo $sid;?></td>
        <td class="am-text-center"><?php echo $stat['money'       ];?></td>
        <td class="am-text-center"><?php echo $stat['moneyGame'   ];?></td>
        <td class="am-text-center"><?php echo $stat['regs'           ];?></td>
        <td class="am-text-center"><?php echo $stat['creates'        ];?></td>
        <td class="am-text-center"><?php echo $stat['rateCreatesRegs'];?></td>
        <td class="am-text-center"><?php echo $stat['orders'         ];?></td>
        <td class="am-text-center"><?php echo $stat['payPlayers'     ];?></td>
        <td class="am-text-center"><?php echo $stat['payPlayers2'    ];?></td>
        <td class="am-text-center"><?php echo $stat['ratePay'        ];?></td>
        <td class="am-text-center"><?php echo $stat['rateMoneyRegs'  ];?></td>
        <td class="am-text-center"><?php echo $stat['arppu'          ];?></td>
        <td class="am-text-center"><?php echo $stat['activePlayers'  ];?></td>
        <td class="am-text-center"><?php echo $stat['arpu'           ];?></td>
    </tr>
    <?php endif;?>
    <?php 
    endforeach;
    endforeach;
    endforeach;
    ?>
    </tbody>
    <tfoot>
        <tr class="am-alert am-alert-success">
            <td class="am-text-nowrop">合计</td>
            <td class="am-text-nowrop">-</td>
            <td class="number am-text-nowrop">-</td>
            <td class="number am-text-nowrop" id="money">0</td>
            <td class="number am-text-nowrop" id="moneyGame">0</td>
            <td class="number am-text-nowrop" id="regs">0</td>
            <td class="number am-text-nowrop" id="creates">0</td>
            <td class="number am-text-nowrop" id="rateCreatesRegs">创角率</td>
            <td class="number am-text-nowrop" id="orders">0</td>
            <td class="number am-text-nowrop" id="payPlayers">0</td>
            <td class="number am-text-nowrop" id="payPlayers2">0</td>
            <td class="number am-text-nowrop" id="ratePay">付费率%</td>
            <td class="number am-text-nowrop" id="rateMoneyRegs">收/注</td>
            <td class="number am-text-nowrop" id="arppu">ARPPU</td>
            <td class="number am-text-nowrop" id="activePlayers">0</td>
            <td class="number am-text-nowrop" id="arpu">ARPU</td>
        </tr>
    </tfoot>
</table>

<script type="text/javascript">

$(function() {

    $('#mytable').tablesort().data('tablesort');
    $('thead th.number').data('sortBy', function(th, td, sorter) {
        return parseInt(td.text(), 10);
    });

    // 日期选择
    var startDate = new Date(2000, 1, 1);
    var endDate = new Date(2099, 11, 25);
    var $alert = $('#my-alert');
    $('#date-start-icon').datepicker().
        on('changeDate.datepicker.amui', function(event) {
            if (event.date.valueOf() > endDate.valueOf()) {
                $alert.find('p').text('开始日期应小于结束日期！').end().show();
            } else {
                $alert.hide();
                startDate = new Date(event.date);
                $('#date-start').val($('#date-start-icon').data('date') + ' 00:00:00');
            }
            $(this).datepicker('close');
        });
    $('#date-end-icon').datepicker().
        on('changeDate.datepicker.amui', function(event) {
            if (event.date.valueOf() < startDate.valueOf()) {
                $alert.find('p').text('结束日期应大于开始日期！').end().show();
            } else {
                $alert.hide();
                endDate = new Date(event.date);
                $('#date-end').val($('#date-end-icon').data('date') + ' 23:59:59');
            }
            $(this).datepicker('close');
        });

    var money = 0; // 3
    var moneyGame = 0; // 4
    var regs = 0; // 5
    var creates = 0; // 6
    var orders = 0; // 8
    var payPlayers = 0; // 9
    var payPlayers2 = 0; // 10
    var activePlayers = 0; // 14

    var cols = $('#mytable thead tr th').length;
    $('#mytable tbody tr').each(function(ii, ee){
        $(ee).children("td").each(function(i, e){
            // console.log(ii+"|"+$(this).text());
            if(i % cols == 3) money+=parseFloat($(this).text());
            if(i % cols == 4) moneyGame+=parseFloat($(this).text());
            if(i % cols == 5) regs+=parseFloat($(this).text());
            if(i % cols == 6) creates+=parseFloat($(this).text());
            if(i % cols == 8) orders+=parseFloat($(this).text());
            if(i % cols == 9) payPlayers+=parseFloat($(this).text());
            if(i % cols == 10) payPlayers2+=parseFloat($(this).text());
            if(i % cols == 14) activePlayers+=parseFloat($(this).text());
        });
    });

    $('#money').html(money.toFixed(2).toString());
    $('#moneyGame').html(moneyGame.toString());
    $('#regs').html(regs.toString());
    $('#creates').html(creates.toString());
    $('#orders').html(orders.toString());
    $('#payPlayers').html(payPlayers.toString());
    $('#payPlayers2').html(payPlayers2.toString());
    $('#activePlayers').html(activePlayers.toString());
        
    var rateCreatesRegs = regs > 0 ? creates / regs * 100 : 0;
    // var ratePay = payPlayers > 0 ? (payPlayers / creates) * 100 : 0;
    // var rateMoneyRegs = regs > 0 ? money / regs : 0;
    var arppu = regs > 0 ? money / payPlayers : 0;
    var arpu = activePlayers > 0 ? money / activePlayers : 0;

    $('#rateCreatesRegs').html(rateCreatesRegs.toFixed(2).toString());
    // $('#ratePay').html(ratePay.toFixed(2).toString());
    // $('#rateMoneyRegs').html(rateMoneyRegs.toFixed(2).toString());
    $('#arppu').html(arppu.toFixed(2).toString());
    $('#arpu').html(arpu.toFixed(2).toString());

});

function sel(pid) {
    var id = "platform-"+pid;
    if($('#'+id).prop("checked")){
        $('.'+id).prop("checked", true);
    }else{
        $('.'+id).prop("checked", false);
    }
}
</script>
<?php $this->endBlock('content');?>
