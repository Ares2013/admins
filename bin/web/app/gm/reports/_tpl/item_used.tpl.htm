<?php $this->setLayout('amazeui');?>

<?php $this->block('title');?>物品消耗统计（统计结果不包括内部号）<?php $this->endBlock('title');?>

<?php $this->block('buttons');?>
<?php echo Game::platformsServersForm($platformid, $serverid);?>
<?php $this->endBlock('buttons');?>

<?php $this->block('content');?>

<script src="assets/js/data_items2.js"></script>
<script src="assets/js/slimtable.js"></script>
<link rel="stylesheet" href="assets/css/slimtable.css">

<form id="mainForm" method="POST" class="am-form">
    <input id="log_type" name="log_type" value="" type="hidden" />
    <!-- panel start -->
    <div class="am-panel am-panel-default">
        <div class="am-panel-hd am-cf" data-am-collapse="{target: '#collapse-panel-search'}">搜索<span class="am-icon-chevron-down am-fr" ></span></div>
        <div class="am-panel-bd am-collapse am-in" id="collapse-panel-search">

            <div class="am-g am-margin-vertical-sm">

                <div class="am-u-sm-12 am-u-md-4">
                    <input type="text" name="kw[player_id]" value="<?php echo $kw['player_id']?>" class="am-form-field am-input-sm" placeholder="角色ID" />
                </div>

                <div class="am-form-icon am-u-sm-12 am-u-md-4">
                    <div class="am-form-icon">
                        <i id="date-start-icon" class="am-icon-calendar"></i>
                        <input id="date-start" type="text" name="kw[time_start]" value="<?php echo $kw['time_start'];?>" class="am-form-field am-input-sm" placeholder="时间-开始" />
                    </div>
                </div>

                <div class="am-form-icon am-u-sm-12 am-u-md-4 am-u-end">
                    <div class="am-form-icon">
                        <i id="date-end-icon" class="am-icon-calendar"></i>
                        <input id="date-end" type="text" name="kw[time_end]" value="<?php echo $kw['time_end'];?>" class="am-form-field am-input-sm" placeholder="时间-结束" />
                    </div>
                </div>
            </div>

            <div class="am-g am-margin-vertical-sm">
                <div class="am-u-sm-12">
                    <button class="am-btn am-btn-default am-input-sm" type="submit">搜索</button>
                </div>
            </div>
        </div>
    </div>
    <!-- panel end -->

    <table class="am-table am-table-striped am-text-sm am-table-hover" id="table">
        <thead>
            <tr>
                <th nowrap>道具名称</th>
                <th nowrap>使用数量</th>
                <th nowrap>消耗元宝</th>
                <th nowrap>消耗礼金</th>
                <th nowrap>消耗银两</th>
                <th nowrap>单价(元宝|礼金|银两)</th>
            </tr>
        </thead>
        <tbody>
        <?php foreach($data as $k=>$v):?>
        <tr>
            <td class="game-item"><?php echo $v['item_id'];?></td>
            <td><?php echo $v['nums'];?></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
        </tr>
        <?php endforeach;?>
        </tbody>
    </table>

</form>

<script>
$(function() {
    $(".game-item").each(function(i, e){
        var id = $(this).text();
        var trObj = $(this).parent();
        var nums = parseInt(trObj.children("td:eq(1)").text());
        var name = typeof(data_items2[id]) != "undefined" ? data_items2[id]['name'] : 'undefined';
        $(this).html(name);
        var ext = typeof(data_items2[id]) != "undefined" ? data_items2[id]['ext'] : {};
        var yb = typeof(ext[1]) != "undefined" ? ext[1] : 0;
        var lj = typeof(ext[2]) != "undefined" ? ext[2] : 0;
        var coin = typeof(ext[3]) != "undefined" ? ext[3] : 0;
        var spend_yb = yb > 0 ? yb * nums: 0;
        var spend_lj = lj > 0 ? lj * nums: 0;
        var spend_coin = coin > 0 ? coin * nums: 0;
        trObj.children("td:eq(2)").html(spend_yb.toString());
        trObj.children("td:eq(3)").html(spend_lj.toString());
        trObj.children("td:eq(4)").html(spend_coin.toString());
        trObj.children("td:eq(5)").html(yb+' | '+lj +' | '+ coin);
    });

    // 日期选择
    var startDate = new Date(2000, 1, 1);
    var endDate = new Date(2099, 11, 25);
    var $alert = $('#my-alert');
    $('#date-start-icon').datepicker().
        on('changeDate.datepicker.amui', function(event) {
            if (event.date.valueOf() > endDate.valueOf()) {
                $alert.find('p').text('开始日期应小于结束日期！').end().show();
            } else {
                $alert.hide();
                startDate = new Date(event.date);
                $('#date-start').val($('#date-start-icon').data('date') + ' 00:00:00');
            }
            $(this).datepicker('close');
        });
    $('#date-end-icon').datepicker().
        on('changeDate.datepicker.amui', function(event) {
            if (event.date.valueOf() < startDate.valueOf()) {
                $alert.find('p').text('结束日期应大于开始日期！').end().show();
            } else {
                $alert.hide();
                endDate = new Date(event.date);
                $('#date-end').val($('#date-end-icon').data('date') + ' 23:59:59');
            }
            $(this).datepicker('close');
        });
    
    $("#table").slimtable();

});

</script>
<?php $this->endBlock('content');?>
